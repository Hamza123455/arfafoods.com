<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arfa Foods</title>
  <link rel="icon" href="logo1.0.00.jpg" type="image/jpg"> <!-- Favicon for tab -->
<style>
  * * * {
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 40px 20px;
  background-color: #f4f6f8;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
}

h1, h2, h3 {
  color: #333;
  margin-bottom: 10px;
}

#employeeFormContainer {
  background-color: #fff;
  padding: 30px 25px;
  border: 1px solid #ddd;
  border-radius: 10px;
  max-width: 700px;
  width: 100%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  margin-bottom: 25px;
}

input, textarea, select {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  margin-bottom: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  transition: border-color 0.3s ease;
  text-align: left;
}

input:focus, textarea:focus, select:focus {
  border-color: #007BFF;
  outline: none;
}

input[type="file"] {
  padding: 5px;
}

button, .btn {
  background-color: #007BFF;
  border: none;
  color: white;
  font-size: 14px;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  margin: 5px 3px 0 0;
  transition: background-color 0.2s ease;
}

.btn:hover, button:hover {
  background-color: #0056b3;
}

.form-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}

/* ✅ Fixed: shows all columns, prevents overlap, scrollable */
.table-container {
  width: 100vw; /* Full screen width */
  max-width: 100%;
  overflow-x: auto; /* Horizontal scroll */
  margin-top: 25px;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  padding-bottom: 5px;
}

table {
  width: 205%; /* Wider than viewport for scrolling */
  min-width: 1200px; /* Forces horizontal scrollbar */
  border-collapse: collapse;
  margin: 0;
  table-layout: auto; /* ✅ Auto layout prevents overlap */
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
  vertical-align: top;
  white-space: normal; /* ✅ Allows wrapping instead of overlap */
  word-break: break-word; /* ✅ Breaks long words like CNICs */
}

th {
  background-color: #a53838;
  color: white;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 2;
}

.hidden {
  display: none;
}

.btn {
  background-color: #007BFF;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 5px;
}

.btn:hover {
  background-color: #0056b3;
}

.form-actions {
  display: flex;
  gap: 5px;
}


</style>

  
</head>
<body>

  <h1>Employee Master Data</h1>

  <!-- Add Button -->
  <button id="showFormBtn" class="btn" onclick="showEmployeeForm()">Add New Employee</button>

  <!-- Form Panel -->
  <div id="employeeFormContainer" class="hidden">
    <form id="employeeForm">
      <input type="number" id="srno" placeholder="Sr No" required>
      <input type="number" id="empid" placeholder="Emp ID" required>
      <input type="text" id="name" placeholder="Name" required>
      <input type="text" id="fathername" placeholder="Father Name" required>
      <input type="text" id="education" placeholder="Education" required>
      <input type="text" id="department" placeholder="Department" required>
      <input type="text" id="dateofbirth" placeholder="Date of Birth" required>
      <input type="text" id="cnic" maxlength="15" placeholder="CNIC (12345-1234567-1)" required>
      <input type="text" id="fathercnic" maxlength="15" placeholder="Father CNIC (12345-1234567-1)" required>
      <input type="text" id="empcurrentaddress" placeholder="Current Address" required>
      <input type="text" id="empparmaddress" placeholder="Permanent Address" required>
      <input type="number" id="empcontactno" placeholder="Contact No" required>
      <input type="number" id="empfatherno" placeholder="Parent Contact No" required>
      <input type="text" id="maritialstatus" placeholder="Marital Status" required>
      <input type="number" id="familycount" placeholder="Family Count" required>
      <input type="text" id="fatherjob" placeholder="Father's Occupation" required>
      <input type="text" id="emppreviousjob" placeholder="Previous Job" required>
      <input type="text" id="referenceby" placeholder="Reference" required>
      <input type="number" id="refcontact" placeholder="Reference Contact" required>
      <input type="text" id="refadd" placeholder="Reference Address" required>
      <input type="text" id="dateofjoining" placeholder="Date of Joining" required>
      <input type="number" id="salary" placeholder="Salary" required>
      
      <!-- NEW FIELD -->
      <select id="status" required>
        <option value="" disabled selected>Select Status</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
      </select>

      <!-- Documents upload (multiple) -->
      <label for="employeeDocs">Upload Documents (you may select many)</label>
      <input type="file" id="employeeDocs" accept="image/*,application/pdf" multiple />

      <div class="form-actions">
        <button type="button" class="btn" onclick="handleAddOrUpdate()">Add / Save Employee</button>
        <button type="button" class="btn" onclick="hideEmployeeForm()" style="background-color:#dc3545;">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Excel Upload -->
  <h3>Import from Excel File</h3>
  <input type="file" id="excelFile" accept=".xlsx" />
  <button class="btn" onclick="importFromExcel()">Import Excel File</button><br>
  <button class="btn" onclick="toggleTable()">Show/Hide Employee Table</button>

  <!-- Export Filters -->
  <br><br>
  <button class="btn" onclick="exportFiltered('All')">Export All</button>
  <button class="btn" onclick="exportFiltered('Active')">Export Active</button>
  <button class="btn" onclick="exportFiltered('Inactive')">Export Inactive</button>

  <!-- Admin Tools -->
  <h3>Admin Actions</h3>
  <input type="password" id="deletePassword" placeholder="Enter password to delete all record" />
  <button class="btn" style="background-color:#dc3545;" onclick="deleteAllEmployees()">Delete Record</button>

  <div id="employeeTableContainer" class="hidden">
    <h2>Employee Records</h2>
    <div id="employeeList"></div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // CONFIG - replace token for production (keep it secret)
    const githubToken = '';
    const owner = 'Hamza123455';
    const repo = 'masterfile';
    const filePath = 'employees.json';
    const docsBasePath = 'documents'; // chosen folder name (you selected B => "documents")
    let employees = [];
    let editingIndex = -1;
    let employeePassword = "";

    const fields = [
      'srno','empid','name','fathername','education','department','dateofbirth','cnic','fathercnic',
      'empcurrentaddress','empparmaddress','empcontactno','empfatherno','maritialstatus','familycount',
      'fatherjob','emppreviousjob','referenceby','refcontact','refadd','dateofjoining','salary','status'
    ];

    // CNIC formatting
    ['cnic', 'fathercnic'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', function () {
        let v = this.value.replace(/\D/g, '');
        if (v.length > 5) v = v.slice(0, 5) + '-' + v.slice(5);
        if (v.length > 13) v = v.slice(0, 13) + '-' + v.slice(13, 14);
        this.value = v.slice(0, 15);
      });
    });

    function showEmployeeForm() {
      document.getElementById('employeeFormContainer').classList.remove('hidden');
      document.getElementById('employeeForm').reset();
      editingIndex = -1;
      document.getElementById('showFormBtn').style.display = 'none';
    }

    function hideEmployeeForm() {
      document.getElementById('employeeFormContainer').classList.add('hidden');
      document.getElementById('showFormBtn').style.display = 'inline-block';
      // clear file input
      const fi = document.getElementById('employeeDocs');
      if (fi) fi.value = '';
    }

    // Load employees.json from GitHub
    async function loadEmployees() {
      try {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
        const res = await fetch(url, {
          headers: { 'Authorization': `token ${githubToken}` }
        });
        if (!res.ok) return; // no file yet or token issue
        const data = await res.json();
        const jsonData = JSON.parse(atob(data.content));
        employees = jsonData.employees || [];
        employeePassword = jsonData.password || "";
        renderEmployeeList();
      } catch (err) {
        console.error('loadEmployees error', err);
      }
    }

    // Update employees.json on GitHub
    async function updateGitHubFile() {
      try {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
        const getRes = await fetch(url, {
          headers: { 'Authorization': `token ${githubToken}` }
        });
        const getJson = await getRes.json();
        const sha = getJson.sha;
        const body = {
          message: "Update employee list",
          content: btoa(JSON.stringify({ password: employeePassword, employees }, null, 2)),
          sha
        };
        await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(body)
        });
      } catch (err) {
        console.error('updateGitHubFile error', err);
      }
    }

    // Helper: file -> base64 (without data: prefix)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // result like "data:application/pdf;base64,...."
          const res = reader.result;
          const idx = res.indexOf(';base64,');
          if (idx === -1) return resolve(res.split(',')[1]);
          resolve(res.slice(idx + 8));
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Helper: check if file exists on GitHub and return sha if exists
    async function getFileSha(path) {
      try {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const res = await fetch(url, {
          headers: { 'Authorization': `token ${githubToken}` }
        });
        if (!res.ok) return null;
        const j = await res.json();
        return j.sha;
      } catch (err) {
        console.error('getFileSha', err);
        return null;
      }
    }

    // Upload a single file to GitHub at given path (path includes filename)
    async function uploadFileToGitHub(path, file, commitMessage = 'Upload document') {
      try {
        const base64 = await fileToBase64(file);
        const sha = await getFileSha(path);
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const body = {
          message: commitMessage,
          content: base64
        };
        if (sha) body.sha = sha; // update if exists
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const txt = await res.text();
          console.error('uploadFileToGitHub failed', res.status, txt);
          return null;
        }
        const j = await res.json();
        // content.download_url is a raw URL to file
        return j.content && j.content.download_url ? j.content.download_url : null;
      } catch (err) {
        console.error('uploadFileToGitHub error', err);
        return null;
      }
    }

    // Upload multiple files for an employee (returns array of URLs)
    async function uploadDocumentsForEmployee(empid, fileList) {
      if (!fileList || fileList.length === 0) return [];
      const uploadedUrls = [];
      // create safe folder path: documents/<empid>/
      for (const file of fileList) {
        // sanitize filename and prefix with timestamp to avoid collisions
        const safeName = file.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\-\.]/g, '');
        const filename = `${Date.now()}_${safeName}`;
        const path = `${docsBasePath}/${empid}/${filename}`;
        const url = await uploadFileToGitHub(path, file, `Upload ${filename} for ${empid}`);
        if (url) uploadedUrls.push(url);
      }
      return uploadedUrls;
    }

    // Main add/update handler that first uploads docs (if any) and then saves employee record
    async function handleAddOrUpdate() {
      // ensure required fields are present
      const empid = document.getElementById('empid').value.trim();
      if (!empid) return alert('Please enter Emp ID');
      const emp = {};
      for (let f of fields) {
        const el = document.getElementById(f);
        if (!el) {
          emp[f] = '';
          continue;
        }
        const v = el.value.trim();
        if (!v) return alert('Please fill all fields');
        emp[f] = v;
      }

      // get files
      const fileInput = document.getElementById('employeeDocs');
      const files = fileInput ? Array.from(fileInput.files) : [];

      // If editing, carry over existing documents array
      if (editingIndex >= 0) {
        // merge with existing documents if present
        const existing = employees[editingIndex] || {};
        emp.documents = Array.isArray(existing.documents) ? [...existing.documents] : [];
      } else {
        emp.documents = [];
      }

      // Upload documents (if any)
      if (files.length > 0) {
        // show simple UI feedback (disable button)
        const btn = document.querySelector('#employeeForm .form-actions .btn');
        if (btn) btn.disabled = true;
        try {
          const urls = await uploadDocumentsForEmployee(emp.empid, files);
          // append new urls
          emp.documents = emp.documents.concat(urls);
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      // Add or update in array
      if (editingIndex >= 0) {
        employees[editingIndex] = emp;
        editingIndex = -1;
      } else {
        employees.push(emp);
      }

      // update employees.json on GitHub (so documents links are stored)
      await updateGitHubFile();

      // reset & render
      document.getElementById('employeeForm').reset();
      hideEmployeeForm();
      renderEmployeeList();
    }

    function renderEmployeeList() {
      const container = document.getElementById('employeeList');
      container.innerHTML = '';

      if (!employees || employees.length === 0) {
        container.innerHTML = '<p>No employee added yet.</p>';
        return;
      }

      // sort by srno
      employees.sort((a, b) => {
        const as = parseInt(a.srno) || 0;
        const bs = parseInt(b.srno) || 0;
        return as - bs;
      });

      const table = document.createElement('table');
      table.id = 'employeeTable';
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      const header = table.insertRow();
      fields.forEach(key => {
        const th = document.createElement('th');
        th.textContent = key;
        header.appendChild(th);
      });
      // documents column header
      const thDocs = document.createElement('th');
      thDocs.textContent = 'Documents';
      header.appendChild(thDocs);

      const thActions = document.createElement('th');
      thActions.textContent = 'Actions';
      header.appendChild(thActions);

      // filter row
      const filterRow = table.insertRow();
      fields.forEach((key, i) => {
        const td = document.createElement('td');
        td.innerHTML = `<input type="text" data-index="${i}" placeholder="Search ${key}" oninput="filterByColumn(this)">`;
        filterRow.appendChild(td);
      });
      filterRow.appendChild(document.createElement('td')); // documents filter cell
      filterRow.appendChild(document.createElement('td')); // actions empty

      // rows
      employees.forEach((e, idx) => {
        const row = table.insertRow();
        fields.forEach(k => {
          const cell = row.insertCell();
          cell.textContent = e[k] ?? '';
        });

        // documents cell
        const docCell = row.insertCell();
        const docs = Array.isArray(e.documents) ? e.documents : [];
        if (docs.length === 0) {
          docCell.textContent = '—';
        } else {
          // show thumbnails / links inline (up to 3)
          const listDiv = document.createElement('div');
          listDiv.style.display = 'flex';
          listDiv.style.gap = '6px';
          docs.forEach((u, i) => {
            const a = document.createElement('a');
            a.href = u;
            a.target = '_blank';
            a.title = u;
            a.style.textDecoration = 'none';
            a.style.fontSize = '12px';
            // If image, show small img; else show file icon
            if (/\.(jpe?g|png|gif|webp|svg)$/i.test(u)) {
              const img = document.createElement('img');
              img.src = u;
              img.style.width = '40px';
              img.style.height = '30px';
              img.style.objectFit = 'cover';
              img.style.border = '1px solid #ccc';
              a.appendChild(img);
            } else {
              const span = document.createElement('span');
              span.textContent = `File ${i+1}`;
              a.appendChild(span);
            }
            listDiv.appendChild(a);
          });
          // if more than 3 show count
          if (docs.length > 3) {
            const more = document.createElement('span');
            more.textContent = `+${docs.length - 3}`;
            more.style.marginLeft = '6px';
            listDiv.appendChild(more);
          }
          docCell.appendChild(listDiv);
        }

        // actions
        const actionCell = row.insertCell();
        actionCell.innerHTML = `
          <button class="btn" onclick="editEmployee(${idx})">Edit</button>
          <button class="btn" style="background-color:#dc3545;" onclick="deleteEmployee(${idx})">Delete</button>
        `;
      });

      container.appendChild(table);
    }

    function editEmployee(i) {
      editingIndex = i;
      const emp = employees[i];
      showEmployeeForm();
      for (const f of fields) {
        const el = document.getElementById(f);
        if (el) el.value = emp[f] ?? '';
      }
      // documents will not be auto-populated into file input (browsers disallow)
      // we rely on existing emp.documents, and new uploaded files will be appended when saving
    }

    async function deleteEmployee(i) {
      if (!confirm('Delete this employee?')) return;
      // Optionally, we won't delete the uploaded docs from GitHub (safer).
      employees.splice(i, 1);
      await updateGitHubFile();
      renderEmployeeList();
    }

    function toggleTable() {
      const wrap = document.getElementById('employeeTableContainer');
      wrap.classList.toggle('hidden');
      if (!wrap.classList.contains('hidden')) renderEmployeeList();
    }

    async function deleteAllEmployees() {
      const pass = document.getElementById('deletePassword').value.trim();
      if (!pass) return alert('Enter password');
      if (pass !== employeePassword) return alert('Incorrect password');
      if (!confirm('Delete ALL records?')) return;
      employees = [];
      await updateGitHubFile();
      renderEmployeeList();
      alert('All employee records deleted.');
    }

    function filterByColumn(input) {
      const index = parseInt(input.getAttribute('data-index'));
      const value = input.value.toLowerCase();
      const table = document.getElementById('employeeTable');
      if (!table) return;
      const rows = table.querySelectorAll('tr');
      for (let r = 2; r < rows.length; r++) {
        const cell = rows[r].cells[index];
        if (cell && !cell.textContent.toLowerCase().includes(value)) {
          rows[r].style.display = 'none';
        } else {
          rows[r].style.display = '';
        }
      }
    }

    // Export with documents (documents will be joined into a single string)
    function exportFiltered(filter) {
      let data = employees;
      if (filter !== 'All') {
        data = employees.filter(e => e.status === filter);
      }
      if (!data || data.length === 0) return alert('No matching employees!');
      // convert documents array to comma-separated string for Excel
      const exportData = data.map(e => {
        const copy = {...e};
        if (Array.isArray(copy.documents)) copy.documents = copy.documents.join(', ');
        return copy;
      });
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `Employees_${filter}`);
      XLSX.writeFile(wb, `EmployeeData_${filter}.xlsx`);
    }

    // Import Excel; expect the documents column to be comma-separated URLs if present
    function importFromExcel() {
      const input = document.getElementById('excelFile');
      if (!input.files.length) return alert('Select an Excel file');
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        const requiredHeaders = fields.concat(['documents']); // allow documents column optionally
        for (const row of jsonData) {
          const emp = {};
          for (const key of fields) {
            if (!(key in row)) return alert(`Missing column: ${key}`);
            emp[key] = row[key];
          }
          // documents column optional
          if ('documents' in row && row.documents) {
            emp.documents = String(row.documents).split(',').map(s => s.trim()).filter(Boolean);
          } else {
            emp.documents = [];
          }
          employees.push(emp);
        }
        updateGitHubFile();
        renderEmployeeList();
      };
      reader.readAsArrayBuffer(input.files[0]);
    }

    // Initial load
    loadEmployees();
  </script>
</body>


</html>