<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sheet Data Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }

    .table-wrapper {
      overflow-x: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }

    input[type="text"], input[type="number"] {
      padding: 6px;
      margin-top: 4px;
      width: 90%;
      box-sizing: border-box;
      margin-bottom: 6px;
    }

    select {
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      white-space: pre-line;
    }

    th {
      background-color: #007BFF;
      color: white;
    }

    td.left-align {
      text-align: left;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    h2 {
      text-align: center;
    }
  </style>
</head>
<body>

  <h2>Production Summary (June - July 2025)</h2>

  <!-- Search box for Item Name -->
  <label for="itemSearch"><strong>Search Item Name:</strong></label>
  <input type="text" id="itemSearch" placeholder="Type item name...">

  <div class="table-wrapper">
    <table id="sheet-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbzKh8UTPQmAmwyhlGk7o2YN157lJI1hBnbU8_kr9LOATAK3uZmUVWxZFV4mqEoehq_5/exec"; // ← Replace with your Apps Script URL

    let rawData = [];
    let headers = [];

    function isNumericColumn(column) {
      return rawData.every(row => !isNaN(parseFloat(row[column])) || row[column] === "");
    }

    function createAdvancedFilters() {
      const thead = document.querySelector("#sheet-table thead");
      const filterRow = document.createElement("tr");

      headers.forEach((header, index) => {
        const th = document.createElement("th");

        // For Item Name search (already above), leave empty filter
        if (index === 1) {
          th.innerHTML = '&nbsp;';
        } else if (isNumericColumn(header)) {
          // Numeric filters
          const select = document.createElement("select");
          select.innerHTML = `
            <option value="">All</option>
            <option value="=">=</option>
            <option value="<"><</option>
            <option value=">">></option>
            <option value="between">Between</option>
          `;

          const input1 = document.createElement("input");
          input1.type = "number";
          input1.placeholder = "Value";

          const input2 = document.createElement("input");
          input2.type = "number";
          input2.placeholder = "and";
          input2.style.display = "none";

          select.addEventListener("change", () => {
            input2.style.display = (select.value === "between") ? "inline-block" : "none";
            filterTable();
          });

          input1.addEventListener("input", filterTable);
          input2.addEventListener("input", filterTable);

          th.appendChild(select);
          th.appendChild(input1);
          th.appendChild(input2);
        } else {
          // Categorical filter
          const select = document.createElement("select");
          select.innerHTML = `<option value="">All</option>`;
          const uniqueVals = [...new Set(rawData.map(row => row[header]).filter(val => val !== ""))];
          uniqueVals.sort().forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
          });
          select.addEventListener("change", filterTable);
          th.appendChild(select);
        }

        filterRow.appendChild(th);
      });

      thead.appendChild(filterRow);
    }

    function filterTable() {
      const tbody = document.querySelector("#sheet-table tbody");
      const searchText = document.getElementById("itemSearch").value.toLowerCase();
      tbody.innerHTML = "";

      const filterCells = document.querySelectorAll("#sheet-table thead tr:nth-child(2) th");

      rawData.forEach(row => {
        let show = true;

        headers.forEach((header, i) => {
          const cell = filterCells[i];

          // Text search on Item Name
          if (i === 1) {
            const itemName = row[header] ? row[header].toString().toLowerCase() : "";
            if (!itemName.includes(searchText)) show = false;
            return;
          }

          if (isNumericColumn(header)) {
            const op = cell.querySelector("select").value;
            const val1 = parseFloat(cell.querySelectorAll("input")[0]?.value || "");
            const val2 = parseFloat(cell.querySelectorAll("input")[1]?.value || "");
            const actual = parseFloat(row[header]);

            if (op === "=" && actual !== val1) show = false;
            if (op === ">" && actual <= val1) show = false;
            if (op === "<" && actual >= val1) show = false;
            if (op === "between" && (actual < val1 || actual > val2)) show = false;
          } else {
            const selVal = cell.querySelector("select")?.value;
            if (selVal && row[header] !== selVal) show = false;
          }
        });

        if (show) {
          const tr = document.createElement("tr");
          headers.forEach((header, i) => {
            const td = document.createElement("td");
            td.textContent = row[header];
            if (i === 1) td.classList.add("left-align"); // Item Name
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      });
    }

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        // Keep all except the first column (Item Code)
        rawData = data.map(row => {
          const keys = Object.keys(row);
          const newRow = {};
          keys.forEach((key, i) => {
            if (i !== 0) newRow[key] = row[key]; // skip index 0 (Item Code)
          });
          return newRow;
        });

        headers = Object.keys(rawData[0]);

        const thead = document.querySelector("#sheet-table thead");
        const headerRow = document.createElement("tr");

        headers.forEach(h => {
          const th = document.createElement("th");
          th.innerHTML = h.replaceAll("\n", "<br>");
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        createAdvancedFilters();
        filterTable();
      })
      .catch(err => {
        console.error("Error:", err);
        document.querySelector(".table-wrapper").innerHTML = "<p style='color:red;'>Failed to load data.</p>";
      });

    document.getElementById("itemSearch").addEventListener("input", filterTable);
  </script>

</body>
</html>
