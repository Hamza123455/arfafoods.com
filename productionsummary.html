<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arfa Foods</title>
  <link rel="icon" href="logo1.0.00.jpg" type="image/jpg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      margin: 0;
    }

    .table-wrapper {
      overflow-x: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }

    input[type="text"], input[type="number"], select {
      padding: 6px;
      margin-top: 4px;
      width: 90%;
      box-sizing: border-box;
      margin-bottom: 6px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
      white-space: pre-line;
    }

    th {
      background-color: #051ab8;
      color: white;
    }

    td.left-align {
      text-align: left;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    h2 {
      text-align: center;
      color: #510b9c;
      font-weight: bolder;
      font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif
    }

    #itemChart {
      max-width: 100%;
      height: 400px;
      display: none;
      margin: 40px auto 0;
    }

    @media print {
      button, #itemSearch, canvas {
        display: none !important;
      }
      thead tr:nth-child(2) {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      input[type="text"] {
        width: 100%;
      }

      .table-wrapper {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <h2>Production Summary (June - July 2025)</h2>

  <label for="itemSearch"><strong>Search Item Name:</strong></label>
  <input type="text" id="itemSearch" placeholder="Type item name...">
  
  <button onclick="exportToPDF()" style="margin: 10px 0; padding: 8px 16px; font-size: 16px;">
    Export Table as PDF
  </button>

  <div class="table-wrapper">
    <table id="sheet-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Chart Canvas -->
  <div>
    <canvas id="itemChart"></canvas>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbzKh8UTPQmAmwyhlGk7o2YN157lJI1hBnbU8_kr9LOATAK3uZmUVWxZFV4mqEoehq_5/exec";

    let rawData = [];
    let headers = [];
    let chartInstance = null;

    function isNumericColumn(column) {
      return rawData.every(row => !isNaN(parseFloat(row[column])) || row[column] === "");
    }

    function createAdvancedFilters() {
      const thead = document.querySelector("#sheet-table thead");
      const filterRow = document.createElement("tr");

      headers.forEach((header) => {
        const th = document.createElement("th");

        if (header.toLowerCase().includes("item name")) {
          th.innerHTML = '&nbsp;';
        } else if (isNumericColumn(header)) {
          const select = document.createElement("select");
          select.innerHTML = `
            <option value="">All</option>
            <option value="=">Equal To</option>
            <option value="<">Less Than</option>
            <option value=">">Greater Than</option>
            <option value="between">Between</option>
          `;

          const input1 = document.createElement("input");
          input1.type = "number";
          input1.placeholder = "Value";

          const input2 = document.createElement("input");
          input2.type = "number";
          input2.placeholder = "and";
          input2.style.display = "none";

          select.addEventListener("change", () => {
            input2.style.display = (select.value === "between") ? "inline-block" : "none";
            filterTable();
          });

          input1.addEventListener("input", filterTable);
          input2.addEventListener("input", filterTable);

          th.appendChild(select);
          th.appendChild(input1);
          th.appendChild(input2);
        } else {
          const select = document.createElement("select");
          select.innerHTML = `<option value="">All</option>`;
          const uniqueVals = [...new Set(rawData.map(row => row[header]).filter(val => val !== ""))];
          uniqueVals.sort().forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
          });
          select.addEventListener("change", filterTable);
          th.appendChild(select);
        }

        filterRow.appendChild(th);
      });

      thead.appendChild(filterRow);
    }

    function filterTable() {
      const tbody = document.querySelector("#sheet-table tbody");
      const searchText = document.getElementById("itemSearch").value.toLowerCase();
      const filterCells = document.querySelectorAll("#sheet-table thead tr:nth-child(2) th");

      tbody.innerHTML = "";
      let visibleRows = [];

      rawData.forEach(row => {
        let show = true;

        headers.forEach((header, i) => {
          const cell = filterCells[i];

          if (header.toLowerCase().includes("item name")) {
            const value = (row[header] || "").toString().toLowerCase();
            if (!value.includes(searchText)) show = false;
            return;
          }

          if (isNumericColumn(header)) {
            const op = cell.querySelector("select")?.value;
            const val1 = parseFloat(cell.querySelectorAll("input")[0]?.value || "");
            const val2 = parseFloat(cell.querySelectorAll("input")[1]?.value || "");
            const actual = parseFloat(row[header]);

            if (op === "=" && actual !== val1) show = false;
            if (op === ">" && actual <= val1) show = false;
            if (op === "<" && actual >= val1) show = false;
            if (op === "between" && (actual < val1 || actual > val2)) show = false;
          } else {
            const selVal = cell.querySelector("select")?.value;
            if (selVal && row[header] !== selVal) show = false;
          }
        });

        if (show) {
          visibleRows.push(row);
          const tr = document.createElement("tr");
          headers.forEach((header) => {
            const td = document.createElement("td");
            td.textContent = row[header];
            if (header.toLowerCase().includes("item name")) td.classList.add("left-align");
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      });

      renderChartIfOneMatch(visibleRows);
    }

    function renderChartIfOneMatch(rows) {
      const canvas = document.getElementById("itemChart");

      if (rows.length === 1) {
        const item = rows[0];

        const planned = parseFloat(item["Planned"]) || 0;
        const requirement = parseFloat(item["Total-Req"]) || 0;
        const produced = parseFloat(item["Produced"]) || 0;
        const furtherRequired = parseFloat(item["Further Required"]) || 0; // ðŸ‘ˆ Direct from sheet

        const max = Math.max(planned, requirement, produced, furtherRequired);

        const data = {
          labels: ["Planned", "Total Required", "Produced", "Further Required"],
          datasets: [{
            label: item["Item Name"] || "Item",
            data: [planned, requirement, produced, furtherRequired],
            backgroundColor: ["#36a2eb", "#3e95cd", "#8e5ea2", "#c45850"]
          }]
        };

        const config = {
          type: 'bar',
          data: data,
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `Production Summary for "${item["Item Name"]}"`
              },
              datalabels: {
                anchor: 'end',
                align: 'top',
                formatter: (val) => {
                  return max > 0 ? `${Math.round((val / max) * 100)}%` : '';
                },
                color: '#333',
                font: { weight: 'bold' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Quantity' }
              }
            }
          },
          plugins: [ChartDataLabels]
        };

        canvas.style.display = "block";
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(canvas, config);
      } else {
        canvas.style.display = "none";
        if (chartInstance) chartInstance.destroy();
      }
    }

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        rawData = data.map(row => {
          const keys = Object.keys(row);
          const newRow = {};
          keys.forEach((key, i) => {
            if (i !== 0) newRow[key] = row[key];
          });
          return newRow;
        });

        headers = Object.keys(rawData[0]);

        const thead = document.querySelector("#sheet-table thead");
        const headerRow = document.createElement("tr");

        headers.forEach(h => {
          const th = document.createElement("th");
          th.innerHTML = h.replaceAll("\n", "<br>");
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        createAdvancedFilters();
        filterTable();
      })
      .catch(err => {
        console.error("Error:", err);
        document.querySelector(".table-wrapper").innerHTML = "<p style='color:red;'>Failed to load data.</p>";
      });

    document.getElementById("itemSearch").addEventListener("input", filterTable);

    function exportToPDF() {
      const originalTitle = document.title;
      document.title = "Production Summary";

      const filterRow = document.querySelector("#sheet-table thead tr:nth-child(2)");
      if (filterRow) filterRow.style.display = "none";

      window.print();

      document.title = originalTitle;
      setTimeout(() => {
        if (filterRow) filterRow.style.display = "";
      }, 1000);
    }
  </script>
</body>
</html>
